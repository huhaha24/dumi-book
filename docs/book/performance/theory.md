---
title: 理论篇
order: 1
toc: content
---

# 性能优化理论篇

---

## 前言

**问**：在浏览器输入 url 后会发生什么？
**答**：会发生以下步骤：

1. 浏览器根据域名去解析，去 DNS 服务器查找域名对应的 ip，若有缓存，直接从缓存中取;
2. 浏览器根据返回的 ip 地址找到对应的服务器，发起 TCP 连接，对没有缓存的内容发送 http 请求获取；
3. 拿到服务端返回的资源后，开始渲染，其中 html 节点会被渲染成 DOM 树，css 会被渲染成 CSSOM 树，最后合成渲染树；

> 不要小看这个题目，这个题目里面包含了很多知识点，列举几个重点问题：
>
> - http 缓存和浏览器缓存
> - TCP 的三次握手和四次挥手
> - 浏览器渲染的过程
> - ...
>
> 上面问题里面可以延伸出很多面试题，而且前端性能优化的思路也可以从这道题出发，说它为我们总结知识体系也不为过。

## 一、网络传输性能优化

### (一) 浏览器知识

- [浏览器缓存](/book/js/browser)
- [浏览器存储](/book/js/browser)

### (二) 资源打包压缩

##### 1、减少请求数

- 将第三方库提取出来，在前端进行缓存
- 使用懒加载，减少首屏的请求次数

##### 2、减少请求资源的体积

- 在 webpack 中配置对 js、css 文件进行压缩

### (三) 图片资源优化

##### 1、给图片设置默认的尺寸

这一步主要是为了防止真实图片尺寸发生变化，导致页面布局发生改变，引起回流。

##### 2、使用字体图标

图标使用 svg 或者字体图标代替，而不是使用图片。因为 svg 和字体图标会随着 html 一起下载，不会再单独发送请求。

💡**额外的知识点**：字体图标的实现和 font-family 是一样的原理，它放大不失真，但是缺点是颜色比较单一，没有图片那么丰富。

#### 3、减少图片请求

可以在 webpack 的 url-loader 中配置将小于 10k 的图片 url 直接转换成 dataUrl 的格式，因为 dataUrl 的格式也不会单独发送请求，如果考虑到缓存的问题，可以尽量在 css 中使用 dataUrl，因为这样它就会随着 css 缓存下来了。

### (四) CDN 加速

#### 原理

CDN 是以空间换时间的策略，通过在各个物理位置部署服务器，达到用户可以就近访问的目的，这样能大幅度减少 http 请求的时间。

#### 特点

- 便于 CDN 业务的独立
- 可以减少主域名无用 cookie 的携带

#### 问题

##### 1、缓存问题

由于 CDN 域名和主域名不同，所以访问的时候需要进行 DNS 解析，解析的过程也会消耗时间。所以我们在`<Link>`标签中使用`dns-prefetch`属性，就可以对 CDN 的域名进行预解析，减少用户的等待时间。

##### 2、跨域问题

CDN 服务器上一般都会设置允许跨域，所以访问的时候，不会产生跨域的问题。

## 二、页面渲染性能优化

### (一) 浏览器渲染过程

![image.png](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/5/28/163a4d01ff8efb71~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

- 第一步：html 节点渲染，构成 DOM 树
- 第二步：css 样式渲染，构成 CSSOM 树
- 第三步：将 DOM 树和 CSSOM 树合并成渲染树（Render Tree）
- 第四步：根据渲染树进行布局
- 第五步：进行像素级的绘制

#### 回流和重绘

**回流（重排）**：当窗口大小发生改变，新增或删除元素或元素尺寸发生改变的时候，就会触发重排；
**重绘**：当 css 修改了元素颜色的时候，会发生重绘；

重排一定会引起重绘，但重绘不一定引起重排。

> 在实际开发中，页面引用了图片的时候，尽量保持图片默认尺寸和请求过来的图片尺寸保持一致，否则容易引起重排，阻塞了页面的渲染。

### (二) 优化策略

#### DOM 的优化

- 减少 DOM 元素的层次嵌套
- 对于频繁的 DOM 操作，建议使用 DOMFragment 组装要修改的内容，减少重排和重绘的次数

#### Js 脚本的优化

> 由于 GUI 渲染线程和 JS 渲染引擎是互斥的，所以 js 脚本的加载会阻塞 DOM 树的渲染，因此我们应该对 js 脚本进行一些优化。

1. 尽量将 js 脚本放在 body 的最下面，因为 DOM 树是从上往下进行构建的，所以尽量在 DOM 树构建完再去加载 js 脚本；
2. 给 js 脚本的`<script>`标签设置`defer`或`async`属性，它们都是异步加载，但是前者会等渲染树渲染完成后才会执行，后者是加载完后立马执行。

## 参考文章

- [网站性能优化实战——从 12.67s 到 1.06s 的故事](https://juejin.cn/post/6844903613790175240#heading-3)
- [「吐血整理」再来一打 Webpack 面试题](https://juejin.cn/post/6844904094281236487)
- [webpack 十连问你能接住几题](https://juejin.cn/post/7002839760792190989)
